---
title: å—è®¾å¤‡å­˜å‚¨
date: 2021-03-30 14:40:19
permalink: /pages/716e4b/
categories:
  - å­¦ä¹ 
  - ceph
tags:
  - 
---



å—æ˜¯ä¸€ä¸ªå­—èŠ‚åºåˆ—ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª 512 å­—èŠ‚çš„æ•°æ®å—ï¼‰ã€‚åŸºäºå—çš„å­˜å‚¨æ¥å£æ˜¯æœ€å¸¸è§çš„å­˜å‚¨æ•°æ®æ–¹æ³•ï¼Œå®ƒä»¬åŸºäºæ—‹è½¬ä»‹è´¨ï¼Œåƒç¡¬ç›˜ã€ CD ã€è½¯ç›˜ã€ç”šè‡³ä¼ ç»Ÿçš„ 9 ç£é“ç£å¸¦ã€‚æ— å¤„ä¸åœ¨çš„å—è®¾å¤‡æ¥å£ä½¿è™šæ‹Ÿå—è®¾å¤‡æˆä¸ºä¸ Ceph è¿™æ ·çš„æµ·é‡å­˜å‚¨ç³»ç»Ÿäº¤äº’çš„ç†æƒ³ä¹‹é€‰ã€‚

<!-- more -->








# RBDä»‹ç»

> RBDå³RADOS Block Deviceçš„ç®€ç§°ï¼ŒRBDå—å­˜å‚¨æ˜¯æœ€ç¨³å®šä¸”æœ€å¸¸ç”¨çš„å­˜å‚¨ç±»å‹ã€‚RBDå—è®¾å¤‡ç±»ä¼¼ç£ç›˜å¯ä»¥è¢«æŒ‚è½½ã€‚ RBDå—è®¾å¤‡å…·æœ‰å¿«ç…§ã€å¤šå‰¯æœ¬ã€å…‹éš†å’Œä¸€è‡´æ€§ç­‰ç‰¹æ€§ï¼Œæ•°æ®ä»¥æ¡å¸¦åŒ–çš„æ–¹å¼å­˜å‚¨åœ¨Cephé›†ç¾¤çš„å¤šä¸ªOSDä¸­ã€‚


æ³¨æ„: Ceph ä¸­åˆšåˆ›å»ºå‡ºæ¥çš„å—æ˜¯ä¸å ç©ºé—´ï¼Œä»Šåç”¨å¤šå¤§ç©ºé—´ï¼Œæ‰ä¼šåœ¨ Ceph ä¸­å ç”¨å¤šå¤§ç©ºé—´ã€‚
 
å—å­˜å‚¨æœ¬è´¨å°±æ˜¯å°†è£¸ç£ç›˜æˆ–ç±»ä¼¼è£¸ç£ç›˜(lvm)è®¾å¤‡æ˜ å°„ç»™ä¸»æœºä½¿ç”¨ï¼Œä¸»æœºå¯ä»¥å¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–å¹¶å­˜å‚¨å’Œè¯»å–æ•°æ®ï¼Œå—è®¾å¤‡è¯»å–é€Ÿåº¦å¿«ä½†æ˜¯ä¸æ”¯æŒå…±äº«ã€‚

cephå¯ä»¥é€šè¿‡å†…æ ¸æ¨¡å—å’Œlibrbdåº“æä¾›å—è®¾å¤‡æ”¯æŒã€‚å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å†…æ ¸æ¨¡å—æŒ‚åœ¨rbdä½¿ç”¨ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨rbdå—è®¾å¤‡å°±åƒä½¿ç”¨æ™®é€šç¡¬ç›˜ä¸€æ ·ï¼Œå¯ä»¥å¯¹å…¶å°±è¡Œæ ¼å¼åŒ–ç„¶åä½¿ç”¨ï¼›å®¢æˆ·åº”ç”¨ä¹Ÿå¯ä»¥é€šè¿‡librbdä½¿ç”¨cephå—ï¼Œå…¸å‹çš„æ˜¯äº‘å¹³å°çš„å—å­˜å‚¨æœåŠ¡ï¼Œäº‘å¹³å°å¯ä»¥ä½¿ç”¨rbdä½œä¸ºäº‘çš„å­˜å‚¨åç«¯æä¾›é•œåƒå­˜å‚¨ã€volumeå—æˆ–è€…å®¢æˆ·çš„ç³»ç»Ÿå¼•å¯¼ç›˜ç­‰ã€‚
 

# RBDå¸¸ç”¨å‘½ä»¤
| å‘½ä»¤ | åŠŸèƒ½ | 
| ------ | ------ | 
| rbd create | åˆ›å»ºå—è®¾å¤‡æ˜ åƒ | 
| rbd ls  | åˆ—å‡º rbd å­˜å‚¨æ± ä¸­çš„å—è®¾å¤‡ | 
| rbd info  | æŸ¥çœ‹å—è®¾å¤‡ä¿¡æ¯ |
| rbd diff  | å¯ä»¥ç»Ÿè®¡ rbd ä½¿ç”¨é‡ |
| rbd map  | æ˜ å°„å—è®¾å¤‡ |
| rbd showmapped  | æŸ¥çœ‹å·²æ˜ å°„å—è®¾å¤‡ |
| rbd remove  | åˆ é™¤å—è®¾å¤‡ |
| rbd resize  | æ›´æ”¹å—è®¾å¤‡çš„å¤§å° |


## å—è®¾å¤‡
### åˆ›å»ºå¿«è®¾å¤‡
```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd create --size 1024 r-_k38-brp-468502291271118213827/lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd -p r-_k38-brp-468502291271118213827 ls
lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-468502291271118213827
lalala
```


### æ‰©å®¹å—è®¾å¤‡
- Ceph å—è®¾å¤‡æ˜ åƒæ˜¯ç²¾ç®€é…ç½®ï¼Œåªæœ‰åœ¨ä½ å¼€å§‹å†™å…¥æ•°æ®æ—¶å®ƒä»¬æ‰ä¼šå ç”¨ç‰©ç†ç©ºé—´ã€‚ç„¶è€Œï¼Œå®ƒä»¬éƒ½æœ‰æœ€å¤§å®¹é‡ï¼Œå°±æ˜¯ä½ è®¾ç½®çš„ --size é€‰é¡¹ã€‚



```
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 1024 MB in 256 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.eb6f6b8b4567
        format: 2
        timestamp: 2021-05-08 16:53:33
        features: layering
        flags: 
root in summer in ~ via ğŸ v2.7.5 
âœ rbd resize  --size 2048 r-_k38-brp-468502291271118213827/lalala
Resizing image: 100% complete...done.
root in summer in ~ via ğŸ v2.7.5 
âœ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 2048 MB in 512 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.eb6f6b8b4567
        format: 2
        timestamp: 2021-05-08 16:53:33
        features: layering
        flags:
```

### ç§»åŠ¨å—è®¾å¤‡
- åŸç†å…¶å®å°±æ˜¯å¿«ç…§çš„å…‹éš†
- ä¾‹å­ï¼šæˆ‘æƒ³æŠŠæ± `r-_k38-brp-468502291271118213827`ä¸­çš„å—`lalala`ç§»åŠ¨åˆ°æ± `r-_k38-brp-070813431311014473975`ä¸­

```
root in summer in ~ via ğŸ v2.7.5 
âœ rados lspools
r-_k60sysmag000
r-_k38-brp-468502291271118213827
r-_k60sysmag001
r-_k38-brp-070813431311014473975
```

```
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd ls r-_k38-brp-468502291271118213827
lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-070813431311014473975
r-_k38-307-101777431315714916604
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap ls r-_k38-brp-468502291271118213827/lalala
SNAPID NAME          SIZE 
    18 lalalasnap 2048 MB 
```

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-070813431311014473975/newmewlalala
2021-05-11 15:43:21.973634 7f141be22900 -1 librbd: parent snapshot must be protected
rbd: clone error: (22) Invalid argument
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd snap protect r-_k38-brp-468502291271118213827/lalala@lalalasnap
root in summer in ~ via ğŸ v2.7.5 
âœ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-070813431311014473975/lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-070813431311014473975
lalala
r-_k38-307-101777431315714916604
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-468502291271118213827
lalala
```



### æŸ¥çœ‹å—è®¾å¤‡


```
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd info r-_k38-brp-468502291271118213827/lalala
rbd image 'lalala':
        size 1024 MB in 256 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.e93a6b8b4567
        format: 2
        timestamp: 2021-05-08 16:38:21
        features: layering
        flags:
```

### ä½¿ç”¨å—è®¾å¤‡

#### æ˜ å°„rbdåˆ°æœ¬åœ°å®¢æˆ·ç«¯
```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd showmapped
root in summer in ~ via ğŸ v2.7.5 
âœ rbd map --image r-_k38-brp-468502291271118213827/lalala
/dev/cephrbd0
root in summer in ~ via ğŸ v2.7.5 
âœ rbd showmapped
id pool                             image  snap device        
0  r-_k38-brp-468502291271118213827 lalala -    /dev/cephrbd0 
```

#### ç›´æ¥lsblkæŸ¥çœ‹
```
root in summer in ~ via ğŸ v2.7.5 
âœ lsblk
NAME        MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda           8:0    0  100G  0 disk 
â”œâ”€sda1        8:1    0    1G  0 part /boot
â”œâ”€sda2        8:2    0    5G  0 part /usr/sysmag_vfs
â””â”€sda3        8:3    0   94G  0 part 
  â””â”€os-root 253:0    0   94G  0 lvm  /
sdb           8:16   0   30G  0 disk 
â””â”€sdb1        8:17   0   30G  0 part /var/lib/ceph/osd/ceph-0
sdc           8:32   0   30G  0 disk 
â””â”€sdc1        8:33   0   30G  0 part /var/lib/ceph/osd/ceph-1
sr0          11:0    1  3.9G  0 rom  
cephrbd0    252:0    0    2G  0 disk 
```

#### æ ¼å¼åŒ–è¯¥è®¾å¤‡
```
root in summer in ~ via ğŸ v2.7.5 
âœ mkfs.xfs /dev/cephrbd0
log stripe unit (4194304 bytes) is too large (maximum is 256KiB)
log stripe unit adjusted to 32KiB
meta-data=/dev/cephrbd0          isize=256    agcount=8, agsize=65536 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=0        finobt=0, sparse=0, rmapbt=0, reflink=0
data     =                       bsize=4096   blocks=524288, imaxpct=25
         =                       sunit=1024   swidth=1024 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=8 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
```

#### æŒ‚è½½è¯¥è®¾å¤‡
```
root in summer in ~ via ğŸ v2.7.5 took 4s 
âœ mkdir /rbdtest
root in summer in ~ via ğŸ v2.7.5 
â¯ mount /dev/cephrbd0 /rbdtest/
root in summer in ~ via ğŸ v2.7.5 
âœ df -h
Filesystem           Size  Used Avail Use% Mounted on
devtmpfs             1.7G     0  1.7G   0% /dev
tmpfs                1.7G   20K  1.7G   1% /dev/shm
tmpfs                1.7G  103M  1.6G   6% /run
tmpfs                1.7G     0  1.7G   0% /sys/fs/cgroup
/dev/mapper/os-root   93G   23G   66G  26% /
/dev/sda1            976M  359M  551M  40% /boot
/dev/sda2            4.8G  696M  3.9G  15% /usr/sysmag_vfs
tmpfs                344M     0  344M   0% /run/user/1000
tmpfs                344M     0  344M   0% /run/user/0
/dev/sdb1             30G   21G  9.9G  68% /var/lib/ceph/osd/ceph-0
/dev/sdc1             30G   21G  9.9G  68% /var/lib/ceph/osd/ceph-1
/dev/cephrbd0        2.0G   33M  2.0G   2% /rbdtest
```

#### å¸è½½å¹¶å–æ¶ˆå—è®¾å¤‡æ˜ å°„

```
root in summer in /rbdtest 
â¯ umount -l /rbdtest
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd unmap /dev/rbd/r-_k38-brp-468502291271118213827/lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd showmapped
root in summer in ~ via ğŸ v2.7.5 
âœ 
```

### åˆ é™¤å—è®¾å¤‡

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd rm r-_k38-brp-468502291271118213827/lalala
Removing image: 100% complete...done.
```

#### å®æ—¶åˆ é™¤

#### å»¶æ—¶åˆ é™¤

- å—ä¿¡æ¯
```
root in summer in ~ via ğŸ v2.7.5 took 20s 
â¯ rbd ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-617-942223241315910956429
r-_k38-808-247448291273718198373
root in summer in ~ via ğŸ v2.7.5 
âœ rbd info r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429
rbd image 'r-_k38-617-942223241315910956429':
        size 4096 MB in 1024 objects
        order 22 (4096 kB objects)
        block_name_prefix: rbd_data.32fb66b8b4567
        format: 2
        timestamp: 2021-05-11 10:25:05
        features: layering
        flags:
```

- æ­¥éª¤

1. é‡å‘½å
```
rbd rename r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429 r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429_-sysmag-del
```

2. æŸ¥çœ‹å¿«ç…§
```
rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-617-942223241315910956429_-sysmag-del | /bin/grep  -v 'SIZE' | /usr/bin/awk   '{print $2}'
```

3. æŸ¥çœ‹block_name_prefix
```
rbd -p r-_k38-brp-468502291271118213827 info r-_k38-617-942223241315910956429_-sysmag-del | /bin/grep  block_name_prefix | /usr/bin/awk  -F. '{print $2}'
```

4. åˆ é™¤å¯¹è±¡åç§°

```
rados -p r-_k38-brp-468502291271118213827 rm rbd_id.r-_k38-617-942223241315910956429_-sysmag-del

rados -p r-_k38-brp-468502291271118213827 rm rbd_header.32fb66b8b4567
```

5. ä»å¯¹è±¡åç§°çš„å¯¹è±¡å›¾ä¸­åˆ é™¤é”®

```
rados -p r-_k38-brp-468502291271118213827 rmomapkey rbd_directory id_32fb66b8b4567

rados -p r-_k38-brp-468502291271118213827 rmomapkey rbd_directory name_r-_k38-617-942223241315910956429_-sysmag-del
```




#### åˆ é™¤åˆ°å›æ”¶ç«™

- é—®é¢˜ï¼šrbd -h æ²¡æœ‰trashå‘½ä»¤ï¼Ÿ

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd  ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-112-507157311312609997653
r-_k38-808-247448291273718198373
root in summer in ~ via ğŸ v2.7.5 
âœ rbd trash move r-_k38-112-507157311312609997653 -p r-_k38-brp-468502291271118213827
rbd: error parsing command 'trash'; -h or --help for usage
```
- åŸæ¥å…¬å¸ç”¨çš„è€ç‰ˆæœ¬ä¸æ”¯æŒtrashï¼Œåªæ˜¯é¡µé¢ä¸Šçš„åˆ é™¤åˆ°äº†å›æ”¶ç«™è€Œå·²


## å¿«ç…§
### åˆ›å»ºå¿«ç…§

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-468502291271118213827
lalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap create --snap lalalasnap r-_k38-brp-468502291271118213827/lalala
```



### æŸ¥çœ‹å¿«ç…§
- `rbd snap ls {poolname}/{rbdname}`

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap ls r-_k38-brp-468502291271118213827/lalala
SNAPID NAME          SIZE 
     4 lalalasnap 2048 MB
```

### ä¿æŠ¤å¿«ç…§

- å…‹éš†æ˜ åƒè¦è®¿é—®çˆ¶å¿«ç…§ã€‚å¦‚æœç”¨æˆ·ä¸å°å¿ƒåˆ é™¤äº†çˆ¶å¿«ç…§ï¼Œæ‰€æœ‰å…‹éš†æ˜ åƒéƒ½ä¼šæŸåã€‚ä¸ºé˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œåœ¨å…‹éš†å‰å¿…é¡»å…ˆä¿æŠ¤å¿«ç…§ã€‚
- ä½ åˆ é™¤ä¸äº†å—ä¿æŠ¤çš„å¿«ç…§ã€‚

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap protect r-_k38-brp-468502291271118213827/lalala@lalalasnap
```

### å…‹éš†å¿«ç…§

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd clone r-_k38-brp-468502291271118213827/lalala@lalalasnap r-_k38-brp-468502291271118213827/newlalala
root in summer in ~ via ğŸ v2.7.5 
âœ rbd ls r-_k38-brp-468502291271118213827
lalala
newlalala
r-_k38-808-247448291273718198373
```

### æ‹å¹³å…‹éš†æ˜ åƒ
- å¦‚æœæ˜ åƒæ˜¯ä¸ªå…‹éš†ï¼Œå°±ä»çˆ¶å¿«ç…§æ‹·è´æ‰€æœ‰å…±äº«çš„å—ï¼Œä½¿å­å¿«ç…§ç‹¬ç«‹äºçˆ¶å¿«ç…§ï¼Œåˆ‡æ–­çˆ¶å­å¿«ç…§é—´çš„è”ç³»ã€‚å¦‚æœæ²¡æœ‰å…‹éš†æ˜ åƒå¼•ç”¨æ­¤çˆ¶å¿«ç…§äº†ï¼Œå°±å¯ä»¥å–æ¶ˆä¿æŠ¤å¹¶åˆ é™¤å®ƒã€‚

```
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd flatten r-_k38-brp-468502291271118213827/newlalala
Image flatten: 100% complete...done.
```

### å–æ¶ˆå¿«ç…§ä¿æŠ¤

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap unprotect r-_k38-brp-468502291271118213827/lalala@lalalasnap
```


### å›æ»šå¿«ç…§

- `rbd snap rollback {pool-name}/{image-name}@{snap-name}`

```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap rollback r-_k38-brp-468502291271118213827/lalala@lalalasnap
Rolling back to snapshot: 100% complete...done.
```

### åˆ é™¤å¿«ç…§

- `rbd snap rm {pool-name}/{image-name}@{snap-name}`


```
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap rm r-_k38-brp-468502291271118213827/lalala@lalalasnap
```

### æ¸…é™¤å¿«ç…§


```
root in summer in ~ via ğŸ v2.7.5 
â¯ rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
SNAPID NAME                              SIZE 
     8 r-_k38-m-044519291302109417845 1024 MB 
     9 r-_k38-m-803818301304009172794 1024 MB 
    10 r-_k38-m-924936321301809791366 1024 MB 
root in summer in ~ via ğŸ v2.7.5 
âœ 
root in summer in ~ via ğŸ v2.7.5 
âœ rbd snap purge r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
Removing all snapshots: 100% complete...done.
root in summer in ~ via ğŸ v2.7.5 took 18s 
âœ rbd snap ls r-_k38-brp-468502291271118213827/r-_k38-808-247448291273718198373
root in summer in ~ via ğŸ v2.7.5 
âœ
```
